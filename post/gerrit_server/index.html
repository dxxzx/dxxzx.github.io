<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.88.1" />

  <title>gerrit service establish guide &middot; Dylan</title>

    

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://dxxzx.github.io/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://dxxzx.github.io/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://dxxzx.github.io/css/blackburn.css">

  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">

  
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet" type="text/css">

  
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

 
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/androidstudio.min.css">
  <script async src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  
  <script async src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/languages/yaml.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://dxxzx.github.io/img/favicon.ico" type="image/x-icon" />

  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://dxxzx.github.io/">Blackburn</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://dxxzx.github.io/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://dxxzx.github.io/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://dxxzx.github.io/tags/"><i class='fa fa-tag fa-fw'></i>Tags</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://dxxzx.github.io/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://dxxzx.github.io/contact/"><i class='fa fa-phone fa-fw'></i>Contact</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/dxxzx" rel="me" target="_blank"><i class="fab fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://stackoverflow.com/users/*" rel="me" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>Stack Overflow</a>
    </li>
    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2017. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>gerrit service establish guide</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>10 Nov 2017</time>
  </div>

  

  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://dxxzx.github.io/tags/gerrit">gerrit</a>
    
  </div>
  
  

</div>

  <h1 id="gerrit-server-establish">Gerrit server establish</h1>
<p>Before install gerrit, please ensure mariadb service and openldap service are installed and configured. If not yet, please refer <a href="mariadb_server.md">mariadb server establish</a>, <a href="openldap_service.md">openldap server establish</a>.</p>
<h2 id="init-gerrit-site">init gerrit site</h2>
<p>using below command to init gerrit site</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">java -jar gerrit.war init -d gerrit-site
</code></pre></div><p>output may look like below:</p>
<pre tabindex="0"><code>Using secure store: com.google.gerrit.server.securestore.DefaultSecureStore
[2017-11-10 21:25:18,220] [main] INFO  com.google.gerrit.server.config.GerritServerConfigProvider : No /home/dylan/gerrit-site/etc/gerrit.config; assuming defaults

*** Gerrit Code Review 2.14.4
*** 

Create '/home/dylan/gerrit-site' [Y/n]? y
</code></pre><h3 id="git-repository-path-section">git repository path section</h3>
<pre tabindex="0"><code>*** Git Repositories
*** 

Location of Git repositories   [git]: 
</code></pre><h3 id="database-section">database section</h3>
<p>before answer gerrit, you should create review database and mariadb for gerrit.
execute below command in mysql prompt.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">USER</span> <span style="color:#e6db74">&#39;gerrit&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span> IDENTIFIED <span style="color:#66d9ef">BY</span> <span style="color:#e6db74">&#39;secret&#39;</span>;
<span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">DATABASE</span> reviewdb <span style="color:#66d9ef">DEFAULT</span> CHARACTER <span style="color:#66d9ef">SET</span> <span style="color:#e6db74">&#39;utf8&#39;</span>;
<span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">ALL</span> <span style="color:#66d9ef">ON</span> reviewdb.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;gerrit&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span>;
FLUSH <span style="color:#66d9ef">PRIVILEGES</span>;
</code></pre></div><p>then, anwser question in gerrit installation</p>
<pre tabindex="0"><code>*** SQL Database
*** 

Database server type           [h2]: mariadb

Gerrit Code Review is not shipped with MariaDB Connector/J 1.5.9
**  This library is required for your configuration. **
Download and install it now [Y/n]? y
Downloading https://repo1.maven.org/maven2/org/mariadb/jdbc/mariadb-java-client/1.5.9/mariadb-java-client-1.5.9.jar ... OK
Checksum mariadb-java-client-1.5.9.jar OK
Server hostname                [localhost]: 
Server port                    [(mariadb default)]: 
Database name                  [reviewdb]: 
Database username              [dylan]: gerrit
gerrit's password              : 
              confirm password : 
</code></pre><h3 id="index-type">index type</h3>
<pre tabindex="0"><code>*** Index
*** 

Type                           [lucene/?]: 
</code></pre><h3 id="authentication-section">authentication section</h3>
<p>before anwser these question, please setup ldap service first. see <a href="openldap_service">openldap_service</a></p>
<pre tabindex="0"><code>*** User Authentication
*** 

Authentication method          [openid/?]: ldap
Git/HTTP authentication        [http/?]: ldap
LDAP server                    [ldap://localhost]: 
LDAP username                  : cn=Manager,dc=my-domain,dc=com
cn=Manager,dc=my-domain,dc=com's password : 
              confirm password : 
Account BaseDN                 : ou=People,dc=my-domain,dc=com
Group BaseDN                   [ou=People,dc=my-domain,dc=com]: ou=Groups,dc=my-domain,dc=com
Enable signed push support     [y/N]? y
</code></pre><h3 id="review-labels">review labels</h3>
<pre tabindex="0"><code>*** Review Labels
*** 

Install Verified label         [y/N]? y
</code></pre><h3 id="send-mail-setting">send mail setting</h3>
<p>If your server could send out email, just leave these question as theirs default anwser.</p>
<pre tabindex="0"><code>*** Email Delivery
*** 

SMTP server hostname           [localhost]: 
SMTP server port               [(default)]: 
SMTP encryption                [none/?]: 
SMTP username                  : 
</code></pre><h3 id="container-section">container section</h3>
<p>if you run gerrit as a standalone user, please create this user first. If you run gerrit in tomcat container, fill it with tomcat</p>
<pre tabindex="0"><code>*** Container Process
*** 

Run as                         [dylan]: gerrit
Java runtime                   [/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.144-7.b01.fc27.x86_64/jre]: 
Copy gerrit-2.14.4.war to gerrit-site/bin/gerrit.war [Y/n]? 
Copying gerrit-2.14.4.war to gerrit-site/bin/gerrit.war
</code></pre><h3 id="sshd-section">sshd section</h3>
<p>just leave it as default.</p>
<pre tabindex="0"><code>*** SSH Daemon
*** 

Listen on address              [*]: 
Listen on port                 [29418]: 
Generating SSH host key ... rsa... dsa... ed25519... ecdsa 256... ecdsa 384... ecdsa 521... done
</code></pre><h3 id="httpd-section">httpd section</h3>
<pre tabindex="0"><code>*** HTTP Daemon
*** 

Behind reverse proxy           [y/N]? 
Use SSL (https://)             [y/N]? 
Listen on address              [*]: 
Listen on port                 [8080]: 
Canonical URL                  [http://176.74.176.187:8080/]: 
</code></pre><h3 id="cache">cache</h3>
<pre tabindex="0"><code>*** Cache
*** 
</code></pre><h3 id="plugins">plugins</h3>
<pre tabindex="0"><code>*** Plugins
*** 

Installing plugins.
Install plugin commit-message-length-validator version v2.14.4 [y/N]? y
Installed commit-message-length-validator v2.14.4
Install plugin download-commands version v2.14.4 [y/N]? y
Installed download-commands v2.14.4
Install plugin hooks version v2.14.4 [y/N]? y
Installed hooks v2.14.4
Install plugin replication version v2.14.4 [y/N]? y
Installed replication v2.14.4
Install plugin reviewnotes version v2.14.4 [y/N]? y
Installed reviewnotes v2.14.4
Install plugin singleusergroup version v2.14.4 [y/N]? y
Installed singleusergroup v2.14.4
Initializing plugins.
</code></pre><h2 id="run-gerrit-in-tomcat-container">run gerrit in tomcat container</h2>
<h3 id="init-gerrit-site-1">init gerrit site</h3>
<p>as last section <a href="#init-gerrit-site">init gerrit site</a></p>
<h3 id="deploy-gerritwar">deploy gerrit.war</h3>
<p>generally, you can just copy gerrit.war to path <em>/var/lib/tomcat/webapps/</em>, tomcat will deploy it automaticlly.
after deployment, you should modify file content of <em>gerrit-launcher/workspace-root.txt</em> under your gerrit app directory, let its content point to gerrit site path.</p>
<pre tabindex="0"><code>/home/dylan/gerrit-site
</code></pre><h3 id="configure-gerrit-app-context">configure gerrit app context</h3>
<p>add below content to tomcat config file <em>server.xml</em>, element Host.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;Context</span> <span style="color:#a6e22e">path=</span><span style="color:#e6db74">&#34;/gerrit&#34;</span> <span style="color:#a6e22e">docBase=</span><span style="color:#e6db74">&#34;/var/lib/tomcat/webapps/gerrit&#34;</span> <span style="color:#a6e22e">reloadable=</span><span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;Resource</span>
        <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;jdbc/ReviewDb&#34;</span>
        <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#34;javax.sql.DataSource&#34;</span>
        <span style="color:#a6e22e">driverClassName=</span><span style="color:#e6db74">&#34;org.mariadb.jdbc.Driver&#34;</span>
        <span style="color:#a6e22e">username=</span><span style="color:#e6db74">&#34;root&#34;</span>
        <span style="color:#a6e22e">password=</span><span style="color:#e6db74">&#34;password&#34;</span>
        <span style="color:#a6e22e">maxWait=</span><span style="color:#e6db74">&#34;10000&#34;</span>
        <span style="color:#a6e22e">maxIdle=</span><span style="color:#e6db74">&#34;30&#34;</span>
        <span style="color:#a6e22e">maxActive=</span><span style="color:#e6db74">&#34;100&#34;</span>
        <span style="color:#a6e22e">url=</span><span style="color:#e6db74">&#34;jdbc:mariadb://localhost:3306/ReviewDB?autoReconnect=true&#34;</span>
        <span style="color:#a6e22e">auth=</span><span style="color:#e6db74">&#34;Container&#34;</span> <span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/Context&gt;</span>
</code></pre></div><h3 id="restart-tomcat">restart tomcat</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">systemctl restart tomcat
</code></pre></div><h2 id="a-gerrit-config-sample">a gerrit config sample</h2>
<pre tabindex="0"><code>[gerrit]
	basePath = /var/lib/gerrit
	serverId = 408f5af4-fcd0-4e39-823a-5b83a514e542
	canonicalWebUrl = http://192.168.99.89:8080/gerrit/
[database]
	type = mariadb
	database = reviewdb
	hostname = localhost
	username = gerrit
[index]
	type = LUCENE
[download]
	command = checkout
	command = cherry_pick
	command = pull
	command = format_patch
	scheme = ssh
[auth]
	type = LDAP
	gitBasicAuthPolicy = LDAP
[gc]
	startTime = 1:00
	interval = 1 w
[gitweb]
	project = ?p=${project}
	branch = ?p=${project}
	revision = ?p=${project}
	filehistory = ?p=${project}
	roottree = ?p=${project}
	file = ?p=${project}
[changeCleanup]
	startTime = 4:00
	interval = 1 w
[ldap]
	server = ldap://127.0.0.1
	username = cn=Manager,dc=tianyisc,dc=com
	accountBase = ou=People,dc=tianyisc,dc=com
	accountPattern = (&amp;(objectClass=person)(uid=${username}))
	accountFullName = displayName
	accountEmailAddress = mail
	groupBase = ou=Groups,dc=tianyisc,dc=com
	groupMemberPattern = (&amp;(objectClass=group)(member=${dn}))
[sendemail]
	smtpServer = smtp.mxhichina.com
	smtpSeverPort = 25
	smtpEncryption = ssl
	smtpUser = gerrit@tianyisc.com
	sslVerify = false
	from = Gerrit Review &lt;gerrit@tianyisc.com&gt;
[receive]
	enableSignedPush = true
[container]
	user = tomcat
	javaHome = /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.144-0.b01.el7_4.x86_64/jre
[automerge]
	botEmail = gerrit@tianyisc.com
[commentlink &quot;change&quot;]
	match = &quot;#/c/(\\d+)&quot;
	html = &quot;&lt;a href=\&quot;/#/c/$1/\&quot;&gt;$1&lt;/a&gt;&quot;
[sshd]
	listenAddress = *:29418
[httpd]
	listenUrl = http://*:8080
[cache]
	directory = /var/cache/gerrit
[commitmessage]
	rejectTooLong = true
[plugins]
	allowRemoteAdmin = true
</code></pre>
  
  <h4><i class="fas fa-share-alt" aria-hidden="true"></i>&nbsp;Share!</h4>
<ul class="share-buttons">
	<li><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fdxxzx.github.io%2fpost%2fgerrit_server%2f" target="_blank" title="Share on Facebook"><i class="fab fa-facebook" aria-hidden="true"></i><span class="sr-only">Share on Facebook</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="https://twitter.com/intent/tweet?source=https%3a%2f%2fdxxzx.github.io%2fpost%2fgerrit_server%2f" target="_blank" title="Tweet"><i class="fab fa-twitter" aria-hidden="true"></i><span class="sr-only">Tweet</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="https://plus.google.com/share?url=https%3a%2f%2fdxxzx.github.io%2fpost%2fgerrit_server%2f" target="_blank" title="Share on Google+"><i class="fab fa-google-plus" aria-hidden="true"></i><span class="sr-only">Share on Google+</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://www.tumblr.com/share?v=3&u=https%3a%2f%2fdxxzx.github.io%2fpost%2fgerrit_server%2f" target="_blank" title="Post to Tumblr"><i class="fab fa-tumblr" aria-hidden="true"></i><span class="sr-only">Post to Tumblr</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2fdxxzx.github.io%2fpost%2fgerrit_server%2f" target="_blank" title="Pin it"><i class="fab fa-pinterest-p" aria-hidden="true"></i><span class="sr-only">Pin it</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://www.reddit.com/submit?url=https%3a%2f%2fdxxzx.github.io%2fpost%2fgerrit_server%2f" target="_blank" title="Submit to Reddit"><i class="fab fa-reddit-alien" aria-hidden="true"></i><span class="sr-only">Submit to Reddit</span></a>
	</li>
</ul>


<style>
	ul.share-buttons{
	  list-style: none;
	  padding: 0;
	}

	ul.share-buttons li{
	  display: inline;
	}

	ul.share-buttons .sr-only{
	  position: absolute;
	  clip: rect(1px 1px 1px 1px);
	  clip: rect(1px, 1px, 1px, 1px);
	  padding: 0;
	  border: 0;
	  height: 1px;
	  width: 1px;
	  overflow: hidden;
	}
</style>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://dxxzx.github.io/post/git_tutorials/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://dxxzx.github.io/post/git_tutorials/">git usage guide</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://dxxzx.github.io/post/project_structure/">android source directory structure</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://dxxzx.github.io/post/project_structure/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>


  
  
  
  
<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'Your Disqus shortname';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  

</div>

</div>
</div>
<script src="https://dxxzx.github.io/js/ui.js"></script>
<script src="https://dxxzx.github.io/js/menus.js"></script>








<script src="https://dxxzx.github.io/js/math-code.js"></script>
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
  


</body>
</html>

